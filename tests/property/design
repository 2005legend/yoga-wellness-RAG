Design Document: Wellness RAG Application - "Ask Me Anything About Yoga"

## Overview

The "Ask Me Anything About Yoga" micro-app implements a comprehensive Retrieval-Augmented Generation (RAG) system specifically designed for yoga and wellness domain knowledge. The system combines modern RAG architecture patterns with robust safety mechanisms to provide users with accurate, contextually relevant, and safe yoga advice.

The architecture follows a microservices approach with clear separation between the RAG pipeline, safety filtering, logging infrastructure, and user interfaces. This design ensures scalability, maintainability, and compliance with health information safety standards.

## Architecture

```mermaid
graph TB
    subgraph "Frontend Layer"
        UI[React/Vue/FastAPI UI]
        API_GW[API Gateway]
    end
    
    subgraph "Application Layer"
        AUTH[Authentication Service]
        RATE[Rate Limiter]
        ROUTER[Request Router]
    end
    
    subgraph "RAG Pipeline"
        SAFETY[Safety Filter]
        EMBED[Embedding Service]
        RETRIEVAL[Retrieval Engine]
        LLM[Response Generator]
    end
    
    subgraph "Data Layer"
        VECTOR_DB[(Vector Database)]
        MONGO[(MongoDB Logs)]
        KB[(Knowledge Base)]
    end
    
    subgraph "Infrastructure"
        CACHE[Redis Cache]
        MONITOR[Monitoring]
    end
    
    UI --> API_GW
    API_GW --> AUTH
    AUTH --> RATE
    RATE --> ROUTER
    ROUTER --> SAFETY
    SAFETY --> EMBED
    EMBED --> RETRIEVAL
    RETRIEVAL --> VECTOR_DB
    RETRIEVAL --> LLM
    LLM --> MONGO
    SAFETY --> MONGO
    EMBED --> CACHE
    RETRIEVAL --> CACHE
    KB --> VECTOR_DB
    
    MONITOR --> MONGO
    MONITOR --> VECTOR_DB
    MONITOR --> CACHE
```

### Key Architectural Decisions

1. **Microservices Architecture**: Each component (safety, embedding, retrieval, generation) is independently deployable and scalable
2. **Vector Database**: Dedicated vector storage (Pinecone/Weaviate/Chroma) for efficient similarity search
3. **Comprehensive Logging**: All interactions logged to MongoDB for monitoring, analysis, and compliance
4. **Multi-layer Safety**: Mandatory safety filtering for pregnancy, medical conditions, and injuries
5. **Caching Strategy**: Redis-based caching for embeddings and frequent queries

## Components and Interfaces

### RAG Pipeline Components

#### Knowledge Base Processor
**Purpose**: Processes and chunks the yoga knowledge base (20-50 articles)
**Key Functions**:
- Semantic chunking using sliding window approach with 256-512 token chunks
- Metadata extraction (source, section, pose type, contraindications)
- **Content Coverage**:
  - Common poses (asanas)
  - Benefits & Contraindications
  - Breathing practices (pranayama)
  - Beginner vs advanced poses
- Citation management (Source 1: Benefits of Shavasana, etc.)

**Interface**:
```typescript
interface KnowledgeProcessor {
  processDocument(document: Document): Promise<Chunk[]>
  updateDocument(documentId: string, document: Document): Promise<void>
  getChunkMetadata(chunkId: string): Promise<ChunkMetadata>
}

interface Chunk {
  id: string
  content: string
  embedding?: number[]
  metadata: ChunkMetadata
  tokens: number
}
```

#### Embedding Service
**Purpose**: Converts text chunks and queries into vector representations
**Key Functions**:
- Generate embeddings using state-of-the-art models (e.g., text-embedding-3-large)
- Batch processing for efficient knowledge base embedding

**Interface**:
```typescript
interface EmbeddingService {
  embedText(text: string): Promise<number[]>
  embedBatch(texts: string[]): Promise<number[][]>
  getEmbeddingDimensions(): number
}
```

#### Retrieval Engine
**Purpose**: Finds and ranks relevant yoga knowledge chunks
**Key Functions**:
- Vector similarity search with configurable thresholds
- Hybrid search combining semantic and keyword matching

**Interface**:
```typescript
interface RetrievalEngine {
  retrieveRelevantChunks(
    query: string, 
    maxResults: number, 
    minSimilarity: number
  ): Promise<RetrievalResult[]>
  
  hybridSearch(
    query: string, 
    keywords: string[], 
    maxResults: number
  ): Promise<RetrievalResult[]>
}

interface RetrievalResult {
  chunk: Chunk
  similarityScore: number
  relevanceRank: number
}
```

#### Response Generator
**Purpose**: Synthesizes retrieved information into coherent yoga advice
**Key Functions**:
- Context-aware response generation using retrieved chunks
- **Source Display**: Clearly lists "Sources used" with titles/IDs
- Response formatting (Markdown support)

**Interface**:
```typescript
interface ResponseGenerator {
  generateResponse(
    query: string, 
    context: RetrievalResult[], 
    safetyFlags: SafetyFlag[]
  ): Promise<GeneratedResponse>
}

interface GeneratedResponse {
  content: string
  sources: SourceCitation[]
  confidence: number
  safetyNotices: string[]
}
```

### Safety and Compliance Components (Mandatory)

#### Safety Filter
**Purpose**: Evaluates queries for high-risk topics (Pregnancy, Medical Conditions)
**Key Functions**:
- **Pregnancy Detection**: Keywords like "pregnant", "first trimester"
- **Condition Detection**: Keywords like "hernia", "glaucoma", "high blood pressure", "surgery"
- **Action**: Marks `isUnsafe = true` in MongoDB
- **UI Feedback**: Triggers "Red Warning Block" in UI

**Interface**:
```typescript
interface SafetyFilter {
  evaluateQuery(query: string): Promise<SafetyAssessment>
  evaluateResponse(response: string, query: string): Promise<SafetyAssessment>
  getRequiredDisclaimers(flags: SafetyFlag[]): string[]
}

interface SafetyAssessment {
  flags: SafetyFlag[]
  riskLevel: 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL'
  allowResponse: boolean
  requiredDisclaimers: string[]
}

interface SafetyFlag {
  type: 'PREGNANCY' | 'MEDICAL_CONDITION' | 'INAPPROPRIATE' | 'EMERGENCY'
  severity: number
  description: string
  mitigationAction: string
}
```

### Data Models

#### User Interaction Log (MongoDB)
```typescript
interface UserInteractionLog {
  id: string
  sessionId: string
  timestamp: Date
  query: {
    original: string
    processed: string
    embedding?: number[]
  }
  retrieval: {
    chunks: RetrievalResult[]
    totalResults: number
  }
  response: {
    content: string
    sources: SourceCitation[]
  }
  safety: {
    isUnsafe: boolean
    flags: string[] // e.g., ["PREGNANCY", "HERNIA"]
    disclaimersShown: string[]
  }
  metadata: {
    userAgent: string
    ipAddress?: string
  }
}
```

#### Knowledge Base Schema
```typescript
interface KnowledgeDocument {
  id: string
  title: string
  content: string
  category: 'ASANA' | 'PRANAYAMA' | 'WELLNESS' | 'MEDITATION'
  source: string // e.g. "Article 3"
  lastUpdated: Date
  chunks: Chunk[]
}
```

## Correctness Properties

### Knowledge Base Processing Properties

**Property 1: Semantic Chunking Consistency**
*For any* yoga article, chunking should produce semantically meaningful segments (256-512 tokens) preserving pose instructions and contraindications together where possible.

**Property 2: Embedding Generation Completeness**
*For any* text chunk or user query, the embedding service should generate a valid vector embedding.

**Property 3: Chunk Storage and Retrieval**
*For any* chunk, it must be retrievable via similarity search with all metadata (Source ID, Article Title) preserved.

### Retrieval and Response Properties

**Property 5: Similarity-Based Retrieval Accuracy**
*For any* user query, retrieved chunks should be ranked by semantic similarity.

**Property 6: Response-Context Consistency**
*For any* generated response, all yoga claims must be traceable to the retrieved context chunks (no hallucinated poses).

**Property 7: Source Citation Completeness**
*For any* generated response, it must include a "Sources used" block listing the retrieved chunks.

### Safety and Compliance Properties (Critical)

**Property 9: High-Risk Query Detection**
*For any* query mentioning "pregnancy", "hernia", "glaucoma", or "surgery", the safety filter MUST mark `isUnsafe=true` and return a safety warning.

**Property 10: Safety Warning Injection**
*For any* unsafe query, the response MUST include a red warning block and the standard disclaimer: "Please consult a doctor or certified yoga therapist..."

**Property 11: Wellness vs Medical Advice Differentiation**
*For any* yoga query, the system should allow helpful pose modifications (e.g., "gentle supine poses") but BLOCK specific medical diagnosis.

**Property 12: Safety Incident Logging**
*For any* safety flag, an entry must be created in the MongoDB logs with `isUnsafe: true`.

### Logging and Monitoring Properties

**Property 13: Comprehensive Interaction Logging**
*For any* interaction, the query, retrieved sources, final answer, and safety flags must be logged to MongoDB.

**Property 18: UI Response and Error Display**
*For any* state (loading, answer, unsafe), the UI must render the correct component (Spinner, Answer Block, Red Warning).

## Testing Strategy

### Dual Testing Approach

**Unit Tests**:
- Specific keyword detection for "pregnant", "hernia".
- Citation formatting checks.

**Property Tests** (Hypothesis/Fast-Check):
- **Safety**: Generate 1000s of queries mixing yoga terms with medical conditions to verify `isUnsafe` triggering.
- **Retrieval**: Verify correct ranking properties.
- **Robustness**: Verify system behavior under varying text lengths and weird inputs.

### Testing Priorities

1. **Safety-Critical Properties**: Pregnancy/Medical condition detection.
2. **Core RAG Functionality**: Retrieval accuracy and Source display.
3. **Persistance**: MongoDB logging verification.